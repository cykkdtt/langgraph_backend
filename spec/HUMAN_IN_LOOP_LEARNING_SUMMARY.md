# LangGraph Human-in-the-Loop ä¸­æ–­åŠŸèƒ½å­¦ä¹ æ€»ç»“

## ğŸ“š å­¦ä¹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†å¯¹LangGraph Human-in-the-Loopï¼ˆäººå·¥å¹²é¢„ï¼‰åŠŸèƒ½çš„æ·±å…¥å­¦ä¹ ï¼ŒåŒ…æ‹¬ç†è®ºæ¦‚å¿µã€é¡¹ç›®å®ç°å’Œå®é™…æµ‹è¯•ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. Human-in-the-Loop åŸºç¡€æ¦‚å¿µ

Human-in-the-Loopæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…è®¸åœ¨è‡ªåŠ¨åŒ–å·¥ä½œæµä¸­å¼•å…¥äººå·¥å¹²é¢„ç‚¹ï¼Œç¡®ä¿å…³é”®å†³ç­–ç”±äººç±»åšå‡ºã€‚

**ä¸»è¦åº”ç”¨åœºæ™¯ï¼š**
- é«˜é£é™©æ“ä½œå®¡æ‰¹
- ç”¨æˆ·è¾“å…¥æ”¶é›†
- é”™è¯¯å¤„ç†å†³ç­–
- ç»“æœå®¡æŸ¥ç¡®è®¤
- å·¥å…·è°ƒç”¨å®¡æŸ¥

### 2. LangGraph ä¸­æ–­æœºåˆ¶

LangGraphæä¾›äº†ä¸¤ç§ä¸»è¦çš„ä¸­æ–­æœºåˆ¶ï¼š

#### 2.1 `interrupt()` å‡½æ•°
```python
from langgraph.types import interrupt

# åˆ›å»ºä¸­æ–­
result = interrupt({
    "type": "approval",
    "title": "éœ€è¦å®¡æ‰¹",
    "description": "é«˜é£é™©æ“ä½œéœ€è¦äººå·¥å®¡æ‰¹",
    "options": [
        {"value": "approve", "label": "æ‰¹å‡†"},
        {"value": "reject", "label": "æ‹’ç»"}
    ]
})
```

#### 2.2 `Command` åŸè¯­
```python
from langgraph.types import Command

# é‡å®šå‘åˆ°ç‰¹å®šèŠ‚ç‚¹
return Command(goto="error_handler")
```

### 3. ä¸­æ–­ç±»å‹åˆ†ç±»

æ ¹æ®é¡¹ç›®å®ç°ï¼Œä¸­æ–­ç±»å‹åŒ…æ‹¬ï¼š

- **HUMAN_INPUT**: éœ€è¦ç”¨æˆ·è¾“å…¥
- **APPROVAL**: éœ€è¦å®¡æ‰¹
- **CONFIRMATION**: éœ€è¦ç¡®è®¤
- **DECISION**: éœ€è¦å†³ç­–
- **TOOL_REVIEW**: å·¥å…·è°ƒç”¨å®¡æŸ¥
- **STATE_EDIT**: çŠ¶æ€ç¼–è¾‘
- **ERROR_HANDLING**: é”™è¯¯å¤„ç†

## ğŸ—ï¸ é¡¹ç›®æ¶æ„åˆ†æ

### 1. æ ¸å¿ƒæ¨¡å—ç»“æ„

```
core/interrupts/
â”œâ”€â”€ interrupt_types.py          # ä¸­æ–­ç±»å‹å®šä¹‰
â”œâ”€â”€ enhanced_interrupt_manager.py  # å¢å¼ºä¸­æ–­ç®¡ç†å™¨
â””â”€â”€ __init__.py
```

### 2. å…³é”®ç±»å’Œæ¨¡å‹

#### 2.1 ä¸­æ–­è¯·æ±‚æ¨¡å‹ (`InterruptRequest`)
```python
class InterruptRequest(BaseModel):
    interrupt_id: str
    run_id: str
    node_id: str
    interrupt_type: InterruptType
    priority: InterruptPriority
    title: str
    message: str
    context: Dict[str, Any]
    options: List[Dict[str, Any]]
    timeout: Optional[int]
    required_approvers: List[str]
    metadata: Dict[str, Any]
    created_at: datetime
    expires_at: Optional[datetime]
```

#### 2.2 å¢å¼ºä¸­æ–­ç®¡ç†å™¨ (`EnhancedInterruptManager`)
ä¸»è¦åŠŸèƒ½ï¼š
- åˆ›å»ºå„ç§ç±»å‹çš„ä¸­æ–­
- ç®¡ç†ä¸­æ–­ç”Ÿå‘½å‘¨æœŸ
- å¤„ç†ä¸­æ–­å“åº”
- è¶…æ—¶å¤„ç†
- é€šçŸ¥ç³»ç»Ÿ

### 3. å·¥ä½œæµé›†æˆ

é¡¹ç›®æä¾›äº† `HumanInLoopAgent` ç±»ï¼Œå±•ç¤ºå¦‚ä½•åœ¨å®é™…æ™ºèƒ½ä½“ä¸­é›†æˆä¸­æ–­åŠŸèƒ½ï¼š

```python
class HumanInLoopAgent(BaseAgent):
    def __init__(self, agent_id: str, name: str, description: str, llm):
        super().__init__(agent_id, name, description, llm)
        self.interrupt_manager = EnhancedInterruptManager()
        self.graph = self._build_graph()
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶

1. **`test_enhanced_interrupt_manager.py`**
   - æµ‹è¯•é¡¹ç›®å¢å¼ºä¸­æ–­ç®¡ç†å™¨åŠŸèƒ½
   - éªŒè¯å„ç§ä¸­æ–­ç±»å‹çš„åˆ›å»ºå’Œå¤„ç†
   - æµ‹è¯•å®¡æ‰¹å·¥ä½œæµã€è¶…æ—¶å¤„ç†ç­‰

2. **`test_langgraph_human_in_loop.py`**
   - åŸºäºLangGraphå®˜æ–¹æ–‡æ¡£çš„å®é™…å·¥ä½œæµæµ‹è¯•
   - å±•ç¤ºå®Œæ•´çš„Human-in-the-Loopå·¥ä½œæµ
   - åŒ…å«çŠ¶æ€æŒä¹…åŒ–ã€é”™è¯¯å¤„ç†ç­‰

3. **`test_interrupt_official_demo.py`**
   - LangGraphå®˜æ–¹ç¤ºä¾‹çš„å®ç°
   - åŸºç¡€ä¸­æ–­å’Œæ¢å¤åŠŸèƒ½æ¼”ç¤º

### 2. æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•å‡é€šè¿‡ï¼ŒéªŒè¯äº†ï¼š
- âœ… å¢å¼ºä¸­æ–­ç®¡ç†å™¨åŸºç¡€åŠŸèƒ½
- âœ… å®¡æ‰¹å·¥ä½œæµ
- âœ… è¶…æ—¶å¤„ç†
- âœ… ä¸åŒç±»å‹ä¸­æ–­
- âœ… ä¸­æ–­ä¸Šä¸‹æ–‡åŠŸèƒ½
- âœ… LangGraphå·¥ä½œæµé›†æˆ
- âœ… çŠ¶æ€æŒä¹…åŒ–

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¸­æ–­è®¾è®¡åŸåˆ™

1. **æ˜ç¡®çš„ä¸­æ–­ç›®çš„**ï¼šæ¯ä¸ªä¸­æ–­éƒ½åº”æœ‰æ¸…æ™°çš„ç›®çš„å’Œé¢„æœŸç»“æœ
2. **åˆç†çš„è¶…æ—¶è®¾ç½®**ï¼šé¿å…æ— é™ç­‰å¾…ï¼Œè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
3. **ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼šæä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡å¸®åŠ©äººå·¥å†³ç­–
4. **æ¸…æ™°çš„é€‰é¡¹è®¾è®¡**ï¼šæä¾›æ˜ç¡®ã€æ˜“ç†è§£çš„é€‰é¡¹

### 2. å·¥ä½œæµè®¾è®¡å»ºè®®

1. **æˆ˜ç•¥æ€§ä¸­æ–­ç‚¹**ï¼šåœ¨å…³é”®å†³ç­–ç‚¹è®¾ç½®ä¸­æ–­
2. **é”™è¯¯æ¢å¤æœºåˆ¶**ï¼šè®¾è®¡å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æµç¨‹
3. **çŠ¶æ€æŒä¹…åŒ–**ï¼šç¡®ä¿ä¸­æ–­æœŸé—´çŠ¶æ€ä¸ä¸¢å¤±
4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šæä¾›æ¸…æ™°çš„ç•Œé¢å’Œåé¦ˆ

### 3. å®‰å…¨è€ƒè™‘

1. **æƒé™éªŒè¯**ï¼šç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥å“åº”ä¸­æ–­
2. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ä¸­æ–­å’Œå“åº”çš„è¯¦ç»†æ—¥å¿—
3. **è¶…æ—¶ä¿æŠ¤**ï¼šé˜²æ­¢æ¶æ„æˆ–æ„å¤–çš„é•¿æ—¶é—´é˜»å¡
4. **è¾“å…¥éªŒè¯**ï¼šéªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥çš„æœ‰æ•ˆæ€§

## ğŸ”§ å®é™…åº”ç”¨åœºæ™¯

### 1. æ•°æ®å¤„ç†å·¥ä½œæµ
```python
# åœ¨æ•°æ®åˆ é™¤å‰éœ€è¦ç¡®è®¤
confirmation = interrupt({
    "type": "confirmation",
    "title": "ç¡®è®¤åˆ é™¤æ•°æ®",
    "description": f"å³å°†åˆ é™¤ {record_count} æ¡è®°å½•ï¼Œæ­¤æ“ä½œä¸å¯é€†",
    "context": {"records": record_count, "table": table_name}
})
```

### 2. ç³»ç»Ÿè¿ç»´æ“ä½œ
```python
# é«˜é£é™©ç³»ç»Ÿæ“ä½œéœ€è¦å®¡æ‰¹
approval = interrupt({
    "type": "approval",
    "title": "ç”Ÿäº§ç¯å¢ƒæ“ä½œå®¡æ‰¹",
    "description": "é‡å¯ç”Ÿäº§æœåŠ¡å™¨",
    "required_approvers": ["ops_manager", "security_officer"],
    "priority": "urgent"
})
```

### 3. ç”¨æˆ·äº¤äº’æ”¶é›†
```python
# æ”¶é›†ç”¨æˆ·åå¥½è®¾ç½®
user_input = interrupt({
    "type": "user_input",
    "prompt": "è¯·é€‰æ‹©æ‚¨çš„åå¥½è®¾ç½®",
    "input_type": "multiple_choice",
    "options": [
        {"value": "option1", "label": "é€‰é¡¹1"},
        {"value": "option2", "label": "é€‰é¡¹2"}
    ]
})
```

## ğŸ“ˆ æ‰©å±•æ–¹å‘

### 1. åŠŸèƒ½å¢å¼º
- æ”¯æŒæ›´å¤šä¸­æ–­ç±»å‹
- å¢å¼ºé€šçŸ¥ç³»ç»Ÿ
- æ”¹è¿›ç”¨æˆ·ç•Œé¢
- æ·»åŠ åˆ†æå’ŒæŠ¥å‘ŠåŠŸèƒ½

### 2. é›†æˆä¼˜åŒ–
- ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ
- æ”¯æŒæ›´å¤šå­˜å‚¨åç«¯
- æ”¹è¿›æ€§èƒ½å’Œæ‰©å±•æ€§
- å¢å¼ºå®‰å…¨æ€§

### 3. ç”¨æˆ·ä½“éªŒ
- ç§»åŠ¨ç«¯æ”¯æŒ
- å®æ—¶é€šçŸ¥
- æ‰¹é‡æ“ä½œ
- è‡ªå®šä¹‰å·¥ä½œæµ

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†LangGraphçš„Human-in-the-LoopåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **ç†è®ºåŸºç¡€**ï¼šæŒæ¡äº†ä¸­æ–­æœºåˆ¶çš„æ ¸å¿ƒæ¦‚å¿µå’Œè®¾è®¡åŸåˆ™
2. **é¡¹ç›®å®ç°**ï¼šåˆ†æäº†é¡¹ç›®ä¸­å¢å¼ºä¸­æ–­ç®¡ç†å™¨çš„æ¶æ„å’Œå®ç°
3. **å®é™…åº”ç”¨**ï¼šé€šè¿‡å¤šä¸ªæµ‹è¯•æ–‡ä»¶éªŒè¯äº†åŠŸèƒ½çš„æ­£ç¡®æ€§
4. **æœ€ä½³å®è·µ**ï¼šæ€»ç»“äº†è®¾è®¡å’Œå®ç°çš„æœ€ä½³å®è·µ

è¿™äº›çŸ¥è¯†ä¸ºåœ¨å®é™…é¡¹ç›®ä¸­å®ç°å¯é ã€ç”¨æˆ·å‹å¥½çš„Human-in-the-Loopå·¥ä½œæµæä¾›äº†åšå®çš„åŸºç¡€ã€‚

---

*å­¦ä¹ å®Œæˆæ—¶é—´ï¼š2025å¹´8æœˆ1æ—¥*  
*æµ‹è¯•æ–‡ä»¶ä½ç½®ï¼š*
- `/Users/cykk/local/langchain-study/langgraph_study/test_enhanced_interrupt_manager.py`
- `/Users/cykk/local/langchain-study/langgraph_study/test_langgraph_human_in_loop.py`
- `/Users/cykk/local/langchain-study/langgraph_study/test_interrupt_official_demo.py`